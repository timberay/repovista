<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RepoVista API 모듈 테스트</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button { margin: 5px; padding: 8px 15px; }
    </style>
</head>
<body>
    <h1>RepoVista API 모듈 테스트</h1>
    
    <div class="test-section">
        <h2>모듈 로딩 테스트</h2>
        <div id="module-loading-results"></div>
        <button onclick="testModuleLoading()">모듈 로딩 테스트</button>
    </div>

    <div class="test-section">
        <h2>HTTP Client 테스트</h2>
        <div id="http-client-results"></div>
        <button onclick="testHttpClient()">HTTP Client 테스트</button>
    </div>

    <div class="test-section">
        <h2>API 통합 테스트</h2>
        <div id="api-integration-results"></div>
        <button onclick="testAPIIntegration()">API 통합 테스트</button>
    </div>

    <!-- API 모듈들 로드 -->
    <script src="frontend/js/http-client.js"></script>
    <script src="frontend/js/utilities.js"></script>
    <script src="frontend/js/repository-api.js"></script>
    <script src="frontend/js/tags-api.js"></script>
    <script src="frontend/js/registry-api.js"></script>
    <script src="frontend/js/api.js"></script>

    <script>
        function logResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            container.appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function testModuleLoading() {
            const container = document.getElementById('module-loading-results');
            container.innerHTML = '';
            
            const modules = [
                { name: 'App', obj: window.App },
                { name: 'App.HttpClient', obj: window.App?.HttpClient },
                { name: 'App.Utilities', obj: window.App?.Utilities },
                { name: 'App.RepositoryAPI', obj: window.App?.RepositoryAPI },
                { name: 'App.TagsAPI', obj: window.App?.TagsAPI },
                { name: 'App.RegistryAPI', obj: window.App?.RegistryAPI },
                { name: 'App.API', obj: window.App?.API }
            ];

            modules.forEach(module => {
                if (module.obj) {
                    logResult('module-loading-results', `✅ ${module.name} 모듈이 성공적으로 로드되었습니다.`, 'success');
                } else {
                    logResult('module-loading-results', `❌ ${module.name} 모듈을 찾을 수 없습니다.`, 'error');
                }
            });

            // 함수들이 존재하는지 확인
            const functions = [
                { name: 'App.API.configure', func: window.App?.API?.configure },
                { name: 'App.API.getHealth', func: window.App?.API?.getHealth },
                { name: 'App.API.getRepositories', func: window.App?.API?.getRepositories }
            ];

            functions.forEach(func => {
                if (typeof func.func === 'function') {
                    logResult('module-loading-results', `✅ ${func.name} 함수가 정의되어 있습니다.`, 'success');
                } else {
                    logResult('module-loading-results', `❌ ${func.name} 함수를 찾을 수 없습니다.`, 'error');
                }
            });
        }

        async function testHttpClient() {
            const container = document.getElementById('http-client-results');
            container.innerHTML = '';
            
            try {
                if (!App.HttpClient) {
                    throw new Error('HttpClient 모듈이 로드되지 않았습니다.');
                }

                logResult('http-client-results', 'HttpClient 설정 테스트 중...', 'info');
                App.HttpClient.configure({
                    timeout: 5000,
                    retryAttempts: 2,
                    retryDelay: 500
                });
                logResult('http-client-results', '✅ HttpClient 설정이 완료되었습니다.', 'success');

                logResult('http-client-results', 'HTTP 요청 테스트 중...', 'info');
                const response = await App.HttpClient.request('http://localhost:8000/api/health');
                logResult('http-client-results', `✅ HTTP 요청 성공: ${JSON.stringify(response)}`, 'success');

            } catch (error) {
                logResult('http-client-results', `❌ HttpClient 테스트 실패: ${error.message}`, 'error');
            }
        }

        async function testAPIIntegration() {
            const container = document.getElementById('api-integration-results');
            container.innerHTML = '';
            
            try {
                if (!App.API) {
                    throw new Error('API 모듈이 로드되지 않았습니다.');
                }

                logResult('api-integration-results', 'API 모듈 초기화 중...', 'info');
                App.API.configure({
                    baseUrl: 'http://localhost:8000/api'
                });
                logResult('api-integration-results', '✅ API 모듈이 설정되었습니다.', 'success');

                // Health check 테스트
                logResult('api-integration-results', 'Health check 테스트 중...', 'info');
                const health = await App.API.getHealth();
                logResult('api-integration-results', `✅ Health check 성공: ${JSON.stringify(health)}`, 'success');

                // Repository 목록 테스트
                logResult('api-integration-results', 'Repository 목록 가져오기 테스트 중...', 'info');
                const repositories = await App.API.getRepositories({ limit: 5 });
                logResult('api-integration-results', `✅ Repository 목록 조회 성공: ${repositories.repositories?.length || 0}개 항목`, 'success');

                // Registry 설정 테스트
                logResult('api-integration-results', 'Registry 설정 가져오기 테스트 중...', 'info');
                try {
                    const config = await App.API.getRegistryConfig();
                    logResult('api-integration-results', `✅ Registry 설정 조회 성공: ${JSON.stringify(config)}`, 'success');
                } catch (configError) {
                    logResult('api-integration-results', `⚠️ Registry 설정 조회 실패 (예상된 오류일 수 있음): ${configError.message}`, 'info');
                }

            } catch (error) {
                logResult('api-integration-results', `❌ API 통합 테스트 실패: ${error.message}`, 'error');
            }
        }

        // 페이지 로드 시 자동으로 모듈 로딩 테스트 실행
        window.addEventListener('load', () => {
            setTimeout(testModuleLoading, 500);
        });
    </script>
</body>
</html>